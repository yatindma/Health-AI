{% extends "layouts/default.html" %}

{% block title %} Heart Attack Predictor {% endblock title %}
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<meta charset="utf-8">
<title>Hearti Health</title>

<style>
  .block-label {
    display: block;
  }

  .block-label+nb-radio-group>nb-radio {
    display: inline;
  }

  .error {
    color: red;
  }
</style>

<form id="healthPredictorForm">
  {% csrf_token %}
  <nb-card>
    <nb-card-header>
      <div>
        <div>
          <h2 style="color:#5781ff;">Heart Attack Predictor</h2>
        </div>
      </div>
    </nb-card-header>
    <nb-card-body>

      <div class="row">

        <div class="col-lg-3 col-md-3">
          <div class="form-group">
            <label for="age" class="label">Age</label>
            <input type="number" class="form-control age" placeholder="Eg: 32" name="age" id="age">
            <!-- {{ form.age }} -->
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="sex" class="label block-label">Gender</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sex" id="inlineRadio2" value="0" checked>
              <label class="form-check-label" for="inlineRadio2">Male</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sex" id="inlineRadio2" value="1">
              <label class="form-check-label" for="inlineRadio2">Female</label>
            </div>
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="cp" class="label block-label">Do you experience Chest Pain?</label>
            <input type="number" class="form-control" placeholder="1 - 4" name="cp">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="trestbps" class="label">
              Blood Pressure Level
            </label>
            <input type="text" class="form-control" placeholder="Eg: 120" name="trestbps">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-3">
          <div class="form-group">
            <label for="chol" class="label">
              Cholesterol Level
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="Ex: 323" name="chol">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="fbs" class="label">
              Fasting Blood Sugar Level
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="0 - 1" name="fbs">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="" class="label">
              Resting Electrocardiographic
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="0 - 1" name="restecg">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="" class="label">
              Maximum Heart Rate Achieved
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="Ex: 180" name="thalach">
          </div>
        </div>
      </div>

      <div class="row">

        <div class="col-lg-3">
          <div class="form-group">
            <label for="exang" class="label block-label">
              Excercise includes Angina
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="exang" id="inlineRadio2" value="1">
              <label class="form-check-label" for="inlineRadio2">Yes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="exang" id="inlineRadio2" value="0" checked>
              <label class="form-check-label" for="inlineRadio2">No</label>
            </div>


          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="oldpeak" class="label">
              Depression induced by exercise
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="0 - 10" name="oldpeak">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="slope" class="label">
              Slope of the peak exercise
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
            </label>
            <input type="text" class="form-control" placeholder="0 - 2" name="slope">
          </div>
        </div>

        <div class="col-lg-3">
          <div class="form-group">
            <label for="ca" class="label">
              <span class="badge badge-pill badge-secondary" nbTooltip="This is a tooltip" nbTooltipStatus="primary"
                nbButton status="primary">i</span>
              Vessels colored by flouoroscopy
            </label>
            <input type="text" class="form-control" placeholder="0 - 10" name="ca">
          </div>
        </div>
      </div>

      <div class="row">

        <div class="col-lg-3">
          <div class="form-group">
            <label for="thal" class="label">
              Thalassemia Level
              <!-- TODO: Add Tooltip for the Thalassemia Level -->
            </label>
            <input type="text" class="form-control" placeholder="1 - 3" name="thal">
          </div>
        </div>
      </div>

    </nb-card-body>
    <div>
      <!-- Handling submit button in ajax below -->
      <input type="submit" class="btn btn-primary health-predictor-btn" onclick="needRatingList();" value="Predict">
    </div>
  </nb-card>
</form>

<!-- Creating Modal -->
<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Prediction</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

  $(function () {
    debugger
    $('#healthPredictorForm').validate({
      rules: {
        age: {
          required: true,
          max: 120,
          min: 10
        },
        cp: {
          required: true,
          max: 3,
          min: 1
        },
        sex: {
          required: true
        },
        trestbps: {
          required: true,
          max: 250,
          min: 60
        },
        chol: {
          required: true
        },
        fbs: {
          required: true,
          max: 250,
          min: 60
        },
        restecg: {
          required: true,
          min:0,
          max:1
        },
        thalach: {
          required: true
        },
        exang: {
          required: true
        },
        oldpeak: {
          required: true
        },
        slope: {
          required: true,
          min: 0,
          max: 2
        },
        ca: {
          required: true
        },
        thal: {
          required: true,
          min: 1,
          max: 3
        }
      }
      // , 
      // messages: {
      //   age: {
      //     required: "* required"

      //   }
      // }
      // , errorPlacement: function (error, element) {
      //   if (element.is(":radio")) {
      //     // error.appendTo(element.parent().parent())
      //   } else {
      //     // This is the default behavior of the script for all fields
      //     error.insertAfter(element);
      //   }
      // }
    });
    $('#healthPredictorForm').on('keyup blur', 'input', function () {
      $(this).valid();
    })

    const bindInitialValidation = () => {
      $('#healthPredictorForm')
    }

    // Handling submit button here
    $(document).on('submit', '#healthPredictorForm', function () {
      debugger
      // alert("Validate Result: ", $('#healthPredictorForm').validate());
      debugger
      event.preventDefault();
      const token = '{{csrf_token}}'
      const data = {}
      data.age = $('input[name=age]').val()
      data.sex = $('input[name=sex]:checked').val()
      data.cp = $('input[name=cp]').val()
      data.trestbps = $('input[name=trestbps]').val()
      data.chol = $('input[name=chol]').val()
      data.fbs = $('input[name=fbs]').val()
      data.restecg = $('input[name=restecg]').val()
      data.thalach = $('input[name=thalach]').val()
      data.exang = $('input[name=exang]:checked').val()
      data.oldpeak = $('input[name=oldpeak]').val()
      data.slope = $('input[name=slope]').val()
      data.ca = $('input[name=ca]').val()
      data.thal = $('input[name=thal]').val()
      debugger
      $.ajax({
        type: 'POST',
        url: '/heart_attack_prediction/heart_prediction_report/',
        dataType: "json",
        async: true,
        beforeSend: function (xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", token);
        },
        data: JSON.stringify(data),
        success: function (response) {
          debugger
          if (response.status === 200) {
            if (response.Result === 0) {
              $('.modal-body').text('You are okay');
              $('#exampleModalLong').modal('show');
            } else {
              $('.modal-body').text('Consult a cardiologist' + '        ' + response['imp_features_weight'] + '          ' + response['important_features']);
              $('#exampleModalLong').modal('show');
            }
          } else {
            $('.modal-body').text('Some Error Occured');
            $('#exampleModalLong').modal('show');
          }
        },
        error: function (xhr, status, errorThrown) {
          alert(xhr.status)
          alert(xhr.responseText)
        }
      });
    })
  })
</script>
{% endblock content %}